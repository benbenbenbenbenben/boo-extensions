namespace Boo.TinyAst.Tests

import System.IO

import Boo.Lang.Compiler.IO
import Boo.Lang.Compiler.Steps
import Boo.OMeta
import Boo.OMeta.Parser
import Boo.TinyAst
import Boo.Lang.PatternMatching
import Boo.Lang.Useful.Attributes
import NUnit.Framework

[TestFixture]
class ParserRoundtripTestFixture:

	def runTestCase(fname as string):		
		fullName = Path.Combine(booRoundtripTestCasesPath(), fname)
		
		OMetaParse(File.ReadAllText(fullName))
//		print o.Errors[0].InnerException if o.Errors.Count > 0
//		cu = o.CompileUnit		
//		m = cu.Modules[0]		
//		print m
//		match parser.module():
//			case SuccessfulMatch(Input: input, Value: m=Module()):
//		assert m is not null
//		assert m.Documentation is not null
//		Assert.AreEqual(normalize(m.Documentation), normalize(m.ToCodeString()))
//				assert input.IsEmpty, input.ToString()

	def OMetaParse(code as string):
		parser = TinyAstParser()
		match parser.module(code):
			case SuccessfulMatch(Input: input, Value: m=Boo.TinyAst.Module()):
				assert m is not null
				assert m.Documentation is not null
				Assert.AreEqual(normalize(m.Documentation), normalize(m.ToCodeString()))
				assert input.IsEmpty, input.ToString()


	def OMetaParseAndRun(code as string):
		compiler = Boo.Lang.Compiler.BooCompiler()
		compiler.Parameters.OutputWriter = StringWriter()
		compiler.Parameters.References.Add(typeof(MacroMacro).Assembly)
		compiler.Parameters.References.Add(typeof(OMetaMacroProcessor).Assembly)
		compiler.Parameters.References.Add(typeof(WhitespaceSensitiveTokenizer).Assembly)		
		compiler.Parameters.References.Add(typeof(TinyAstParser).Assembly)		
		compiler.Parameters.References.Add(GetType().Assembly)
		
		p = Boo.Lang.Compiler.Pipelines.ExpandMacros()		
		p.Add(RunAssembly())		
		p.Replace(typeof(Parsing), Boo.TinyAst.TinyAstParserStep())
		
		compiler.Parameters.Pipeline = p
		compiler.Parameters.Input.Add(StringInput("", code))
		return compiler.Run()

	def normalize(s as string):
		return s.Trim().Replace("\r\n", "\n")
		
	[once] def booRoundtripTestCasesPath():
		
		return Path.Combine(
					findSiblingBooExtensionsDirectory(parentDirectory(System.Environment.CurrentDirectory)),
					"tests/testcases/roundtrip")
		
	def findSiblingBooExtensionsDirectory(dir as string) as string:
		
		booDir = Path.Combine(dir, "boo-extensions")
		if Directory.Exists(booDir): return booDir
		
		parent = parentDirectory(dir)
		assert parent != dir
		return findSiblingBooExtensionsDirectory(parent)
		
	def parentDirectory(dir as string):
		return Path.GetDirectoryName(dir)

	[Test]
	def and_or_1():
		runTestCase("and-or-1.boo")
		
	[Test]
	def arrays_1():
//	Changed from:
//	
//	for n, a in zip(names, attributes):
//		print("\${n} \${a}!")
//	
//	to:
//		
//	for (n, a) in zip(names, attributes):
//		print("\${n} \${a}!")		
		runTestCase("arrays-1.boo")	

	[Test]
	def arrays_2():
// Changed from:
//
// for i in 1, 2, 3
//
// to:
//
// for i in (1, 2, 3)
		runTestCase("arrays-2.boo")	

	[Test]
	def arrays_3():
// Changed from:
//
// a = 1, b=2, 3
//
// to:
//
// a = (1, b=2, 3)
		runTestCase("arrays-3.boo")

	[Test]
	def arrays_4():
		runTestCase("arrays-4.boo")		

	[Test]
	def arrays_5():
		runTestCase("arrays-5.boo")
	
	[Test]
	def arrays_6():
		runTestCase("arrays-6.boo")	

	[Test]
	def as_1():
		runTestCase("as-1.boo")
	

	[Test]
	def assignment_1():
		runTestCase("assignment-1.boo")
	

	[Test]
	def ast_literal_enum():
		runTestCase("ast-literal-enum.boo")
	

	[Test]
	def ast_literals_1():
		runTestCase("ast-literals-1.boo")
	

	[Test]
	def ast_literals_10():
		runTestCase("ast-literals-10.boo")
	

	[Test]
	def ast_literals_11():
		runTestCase("ast-literals-11.boo")
	

	[Test]
	def ast_literals_2():
		runTestCase("ast-literals-2.boo")
	

	[Test]
	def ast_literals_3():
		runTestCase("ast-literals-3.boo")
	

	[Test]
	def ast_literals_4():
		runTestCase("ast-literals-4.boo")
	

	[Test]
	def ast_literals_5():
		runTestCase("ast-literals-5.boo")
	

	[Test]
	def ast_literals_6():
		runTestCase("ast-literals-6.boo")
	

	[Test]
	def ast_literals_7():
		runTestCase("ast-literals-7.boo")
	

	[Test]
	def ast_literals_8():
		runTestCase("ast-literals-8.boo")
	

	[Test]
	def ast_literals_9():
		runTestCase("ast-literals-9.boo")
	

	[Test]
	def ast_literals_if_it_looks_like_a_block_1():
		runTestCase("ast-literals-if-it-looks-like-a-block-1.boo")
	

	[Test]
	def at_operator():
		runTestCase("at-operator.boo")
	

	[Test]
	def attributes_1():
		runTestCase("attributes-1.boo")
	

	[Test]
	def attributes_2():
		runTestCase("attributes-2.boo")
	

	[Test]
	def bool_literals_1():
		runTestCase("bool-literals-1.boo")
	

	[Test]
	def callables_1():
		runTestCase("callables-1.boo")
	

	[Test]
	def callables_2():
		runTestCase("callables-2.boo")
	

	[Test]
	def callables_with_varags():
		runTestCase("callables-with-varags.boo")
	

	[Test]
	def cast_1():
		runTestCase("cast-1.boo")
	

	[Test]
	def char_1():
		runTestCase("char-1.boo")
	

	[Test]
	def char_2():
		runTestCase("char-2.boo")
	

	[Test]
	def class_1():
		runTestCase("class-1.boo")
	

	[Test]
	def class_2():
		runTestCase("class-2.boo")
	

	[Test]
	def class_3():
		runTestCase("class-3.boo")
	

	[Test]
	def closures_1():
		runTestCase("closures-1.boo")
	

	[Test]
	def closures_10():
		runTestCase("closures-10.boo")
	

	[Test]
	def closures_11():
		runTestCase("closures-11.boo")
	

	[Test]
	def closures_12():
		runTestCase("closures-12.boo")
	

	[Test]
	def closures_13():
		runTestCase("closures-13.boo")
	

	[Test]
	def closures_14():
		runTestCase("closures-14.boo")
	

	[Test]
	def closures_15():
		runTestCase("closures-15.boo")
	

	[Test]
	def closures_16():
		runTestCase("closures-16.boo")
	

	[Test]
	def closures_17():
		runTestCase("closures-17.boo")
	

	[Test]
	def closures_18():
		runTestCase("closures-18.boo")
	

	[Test]
	def closures_19():
		runTestCase("closures-19.boo")
	

	[Test]
	def closures_2():
		runTestCase("closures-2.boo")
	

	[Test]
	def closures_20():
		runTestCase("closures-20.boo")
	

	[Test]
	def closures_21():
		runTestCase("closures-21.boo")
	

	[Test]
	def closures_22():
		runTestCase("closures-22.boo")
	

	[Test]
	def closures_3():
		runTestCase("closures-3.boo")
	

	[Test]
	def closures_4():
		runTestCase("closures-4.boo")
	

	[Test]
	def closures_5():
		runTestCase("closures-5.boo")
	

	[Test]
	def closures_6():
		runTestCase("closures-6.boo")
	

	[Test]
	def closures_7():
		runTestCase("closures-7.boo")
	

	[Test]
	def closures_8():
		runTestCase("closures-8.boo")
	

	[Test]
	def closures_9():
		runTestCase("closures-9.boo")
	

	[Test]
	def collection_initializer():
		runTestCase("collection-initializer.boo")
	

	[Test]
	def comments_1():
		runTestCase("comments-1.boo")
	

	[Test]
	def comments_2():
		runTestCase("comments-2.boo")
	

	[Test]
	def comments_3():
		runTestCase("comments-3.boo")
	

	[Test]
	def comments_4():
		runTestCase("comments-4.boo")
	

	[Test]
	def conditional_1():
		runTestCase("conditional-1.boo")
	

	[Test]
	def declarations_1():
		runTestCase("declarations-1.boo")
	

	[Test]
	def declarations_2():
		runTestCase("declarations-2.boo")
	

	[Test]
	def declarations_3():
		runTestCase("declarations-3.boo")
	

	[Test]
	def double_literals_1():
		runTestCase("double-literals-1.boo")
	

	[Test]
	def dsl_1():
		runTestCase("dsl-1.boo")
	

	[Test]
	def elif_1():
		runTestCase("elif-1.boo")
	

	[Test]
	def elif_2():
		runTestCase("elif-2.boo")
	

	[Test]
	[Ignore("Enumerable type shortcut is not supported")]
	def enumerable_type_shortcut():
		runTestCase("enumerable-type-shortcut.boo")
	

	[Test]
	def enums_1():
		runTestCase("enums-1.boo")
	

	[Test]
	def events_1():
		runTestCase("events-1.boo")
	

	[Test]
	def explode_1():
		runTestCase("explode-1.boo")
	

	[Test]
	def explode_2():
		runTestCase("explode-2.boo")
	

	[Test]
	def expressions_1():
		runTestCase("expressions-1.boo")
	

	[Test]
	def expressions_2():
		runTestCase("expressions-2.boo")
	

	[Test]
	def expressions_3():
		runTestCase("expressions-3.boo")
	

	[Test]
	def expressions_4():
		runTestCase("expressions-4.boo")
	

	[Test]
	def expressions_5():
		runTestCase("expressions-5.boo")
	

	[Test]
	def extensions_1():
		runTestCase("extensions-1.boo")
	

	[Test]
	def fields_1():
		runTestCase("fields-1.boo")
	

	[Test]
	def fields_2():
		runTestCase("fields-2.boo")
	

	[Test]
	def fields_3():
		runTestCase("fields-3.boo")
	

	[Test]
	def fields_4():
		runTestCase("fields-4.boo")
	

	[Test]
	def fields_5():
		runTestCase("fields-5.boo")
	

	[Test]
	def fields_6():
		runTestCase("fields-6.boo")
	

	[Test]
	def for_or_1():
		runTestCase("for_or-1.boo")
	

	[Test]
	def for_or_then_1():
		runTestCase("for_or_then-1.boo")
	

	[Test]
	def for_then_1():
		runTestCase("for_then-1.boo")
	

	[Test]
	def generators_1():
		runTestCase("generators-1.boo")
	

	[Test]
	def generators_2():
		runTestCase("generators-2.boo")
	

	[Test]
	def generators_3():
		runTestCase("generators-3.boo")
	

	[Test]
	def generic_method_1():
		runTestCase("generic-method-1.boo")
	

	[Test]
	def generic_method_2():
		runTestCase("generic-method-2.boo")
	

	[Test]
	def generic_method_3():
		runTestCase("generic-method-3.boo")
	

	[Test]
	def generic_parameter_constraints():
		runTestCase("generic-parameter-constraints.boo")
	

	[Test]
	def generics_1():
		runTestCase("generics-1.boo")
	

	[Test]
	def generics_2():
		runTestCase("generics-2.boo")
	

	[Test]
	def generics_3():
		runTestCase("generics-3.boo")
	

	[Test]
	[Ignore("Generic placeholders are not supported")]
	def generics_4():
		runTestCase("generics-4.boo")
	

	[Test]
	def generics_5():
		runTestCase("generics-5.boo")
	

	[Test]
	def getset_1():
		runTestCase("getset-1.boo")
	

	[Test]
	def goto_1():
		runTestCase("goto-1.boo")
	

	[Test]
	[Ignore("Goto labels are not supported")]
	def goto_2():
		runTestCase("goto-2.boo")
	

	[Test]
	[Ignore("Hash is not supported")]
	#There is conflict because curly brakets are also used in closures so it's not possible to determine correct priority of tuple for both cases
	def hash_1():
		runTestCase("hash-1.boo")
	

	[Test]
	[Ignore("Hash is not supported")]
	#There is conflict because curly brakets are also used in closures so it's not possible to determine correct priority of tuple for both cases
	def hash_initializer():
		runTestCase("hash-initializer.boo")
	

	[Test]
	def iif_1():
		runTestCase("iif-1.boo")
	

	[Test]
	def import_1():
		runTestCase("import-1.boo")
	

	[Test]
	def import_2():
		runTestCase("import-2.boo")
	

	[Test]
	def in_not_in_1():
		runTestCase("in-not-in-1.boo")
	

	[Test]
	def in_not_in_2():
		runTestCase("in-not-in-2.boo")
	

	[Test]
	def in_not_in_3():
		runTestCase("in-not-in-3.boo")
	

	[Test]
	def inplace_1():
		runTestCase("inplace-1.boo")
	

	[Test]
	def internal_generic_callable_type_1():
		runTestCase("internal-generic-callable-type-1.boo")
	

	[Test]
	def internal_generic_type_1():
		runTestCase("internal-generic-type-1.boo")
	

	[Test]
	def internal_generic_type_2():
		runTestCase("internal-generic-type-2.boo")
	

	[Test]
	def internal_generic_type_3():
		runTestCase("internal-generic-type-3.boo")
	

	[Test]
	def internal_generic_type_4():
		runTestCase("internal-generic-type-4.boo")
	

	[Test]
	def internal_generic_type_5():
		runTestCase("internal-generic-type-5.boo")
	

	[Test]
	def internal_generic_type_6():
		runTestCase("internal-generic-type-6.boo")
	

	[Test]
	def interpolation_1():
		runTestCase("interpolation-1.boo")
	

	[Test]
	def interpolation_2():
		runTestCase("interpolation-2.boo")
	

	[Test]
	def interpolation_3():
		runTestCase("interpolation-3.boo")
	

	[Test]
	def interpolation_4():
		runTestCase("interpolation-4.boo")
	

	[Test]
	def invocation_1():
		runTestCase("invocation-1.boo")
	

	[Test]
	def isa_1():
		runTestCase("isa-1.boo")
	

	[Test]
	def keywords_as_members_1():
		runTestCase("keywords-as-members-1.boo")
	

	[Test]
	def line_continuation_1():
		runTestCase("line-continuation-1.boo")
	

	[Test]
	def list_1():
		runTestCase("list-1.boo")
	

	[Test]
	def long_literals_1():
		runTestCase("long-literals-1.boo")
	

	[Test]
	def macro_doc():
		runTestCase("macro-doc.boo")
	

	[Test]
	def macros_1():
		runTestCase("macros-1.boo")
	

	[Test]
	def macros_2():
		runTestCase("macros-2.boo")
	

	[Test]
	def macros_3():
		runTestCase("macros-3.boo")
	

	[Test]
	def macros_anywhere_1():
		runTestCase("macros-anywhere-1.boo")
	

	[Test]
	def method_declaration_in_macro_application():
		runTestCase("method-declaration-in-macro-application.boo")
	

	[Test]
	def method_declarations_in_nested_macro_application():
		runTestCase("method-declarations-in-nested-macro-application.boo")
	

	[Test]
	def module_1():
		runTestCase("module-1.boo")
	

	[Test]
	def module_2():
		runTestCase("module-2.boo")
	

	[Test]
	def module_3():
		runTestCase("module-3.boo")
	

	[Test]
	def named_arguments_1():
		runTestCase("named-arguments-1.boo")
	

	[Test]
	def named_arguments_2():
		runTestCase("named-arguments-2.boo")
	

	[Test]
	def new_1():
		runTestCase("new-1.boo")
	

	[Test]
	def not_1():
		runTestCase("not-1.boo")
	

	[Test]
	def not_2():
		runTestCase("not-2.boo")
	

	[Test]
	def null_1():
		runTestCase("null-1.boo")
	

	[Test]
	//[Ignore("Ommited member is not supported")]
	def omitted_member_target_1():
		runTestCase("omitted-member-target-1.boo")
	

	[Test]
	def ones_complement_1():
		runTestCase("ones-complement-1.boo")
	

	[Test]
	[Ignore("Regex is not supported")]
	def regex_literals_1():
		runTestCase("regex-literals-1.boo")
	

	[Test]
	[Ignore("Regex is not supported")]
	def regex_literals_2():
		runTestCase("regex-literals-2.boo")
	

	[Test]
	def return_1():
		runTestCase("return-1.boo")
	

	[Test]
	def return_2():
		runTestCase("return-2.boo")
	

	[Test]
	def self_1():
		runTestCase("self-1.boo")
	

	[Test]
	def semicolons_1():
		runTestCase("semicolons-1.boo")
	

	[Test]
	[Ignore("Slicing is not supported")]
	def slicing_1():
		runTestCase("slicing-1.boo")
	

	[Test]
	[Ignore("Slicing is not supported")]	
	def slicing_2():
		runTestCase("slicing-2.boo")
	

	[Test]
	def splicing_1():
		runTestCase("splicing-1.boo")
	

//	[Test]
//	def splicing_class_body():
//		runTestCase("splicing-class-body.boo")
//	
//
//	[Test]
//	def splicing_enum_body():
//		runTestCase("splicing-enum-body.boo")
	

	[Test]
	def string_literals_1():
		runTestCase("string-literals-1.boo")
	

	[Test]
	def struct_1():
		runTestCase("struct-1.boo")
	

	[Test]
	[Ignore("Timespan literals are not supported")]
	def timespan_literals_1():
		runTestCase("timespan-literals-1.boo")
	

	[Test]
	def try_1():
		runTestCase("try-1.boo")
	

	[Test]
	def try_2():
		runTestCase("try-2.boo")
	

	[Test]
	[Ignore("Enumerable type shortcut is not supported")]
	def type_references_1():
		runTestCase("type-references-1.boo")
	

	[Test]
	def unless_1():
		runTestCase("unless-1.boo")
	

	[Test]
	def varargs_1():
		runTestCase("varargs-1.boo")
	

	[Test]
	def while_or_1():
		runTestCase("while_or-1.boo")
	

	[Test]
	def while_or_then_1():
		runTestCase("while_or_then-1.boo")
	

	[Test]
	def while_then_1():
		runTestCase("while_then-1.boo")
	

	[Test]
	def xor_1():
		runTestCase("xor-1.boo")
	

	[Test]
	def yield_1():
		runTestCase("yield-1.boo")
	
		
